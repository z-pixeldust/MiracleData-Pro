<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #ffffff;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .container {
            padding: 16px;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        h1 {
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 16px 0;
            color: #000000;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #E5E5E5;
            margin-bottom: 16px;
            position: sticky;
            top: 0;
            background-color: #ffffff;
            z-index: 10;
        }
        
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            font-size: 13px;
            color: #666;
            transition: all 0.2s ease;
        }
        
        .tab.active {
            border-bottom: 2px solid #0D99FF;
            color: #0D99FF;
        }
        
        .tab:hover:not(.active) {
            color: #333;
            background-color: #f5f5f5;
        }
        
        .tab-content {
            display: none;
            padding: 8px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .checkbox-group {
            margin-bottom: 16px;
        }
        
        .checkbox-group h3 {
            font-size: 13px;
            font-weight: 600;
            margin: 0 0 8px 0;
        }
        
        .checkbox-item {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        button {
            background-color: #0D99FF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-right: 8px;
            transition: background-color 0.2s ease;
        }
        
        button:hover {
            background-color: #0A85E9;
        }
        
        button:active {
            background-color: #0871C4;
        }
        
        button:disabled {
            background-color: #E5E5E5;
            color: #999;
            cursor: not-allowed;
        }
        
        button.secondary {
            background-color: #F5F5F5;
            color: #333;
            border: 1px solid #E5E5E5;
        }
        
        button.secondary:hover {
            background-color: #EBEBEB;
        }
        
        button.secondary:active {
            background-color: #DDDDDD;
        }
        
        .error-message {
            background-color: #FDEBEB;
            color: #D93025;
            padding: 12px;
            border-radius: 6px;
            margin: 16px 0;
            border: 1px solid #F7CBCB;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #E5E5E5;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }
        
        .form-group input[type="text"]:focus,
        .form-group select:focus {
            border-color: #0D99FF;
            outline: none;
            box-shadow: 0 0 0 2px rgba(13, 153, 255, 0.2);
        }
        
        .form-group input[type="file"] {
            margin-bottom: 8px;
        }
        
        .section {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #E5E5E5;
        }
        
        .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .section h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 12px 0;
        }
        
        .validation-message {
            margin-top: 8px;
            font-size: 12px;
        }
        
        .validation-message.valid {
            color: #1C7C4E;
        }
        
        .validation-message.invalid {
            color: #D93025;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
        }

        .success-message {
            background-color: #E7F5EE;
            color: #1C7C4E;
            padding: 12px;
            border-radius: 6px;
            margin: 16px 0;
            border: 1px solid #C3E6D4;
            font-weight: 500;
        }
        
        .preview-grid {
            display: grid;
            gap: 1px;
            background-color: #E5E5E5;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .preview-cell {
            background-color: white;
            padding: 8px;
            font-size: 12px;
            border: none;
            min-height: 32px;
            display: flex;
            align-items: center;
        }
        
        .preview-header {
            background-color: #F5F5F5;
            font-weight: 600;
            color: #333;
        }
        
        .preview-cell.ignored {
            background-color: #F8F8F8;
            color: #999;
            text-decoration: line-through;
        }
        
        .column-mapping-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #E5E5E5;
            border-radius: 4px;
            background-color: #FAFAFA;
        }
        
        .column-mapping-item label {
            flex: 1;
            margin: 0;
            font-weight: 500;
        }
        
        .column-mapping-item select {
            flex: 1;
            margin-left: 8px;
            padding: 4px 8px;
            border: 1px solid #E5E5E5;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .column-mapping-item input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .ignore-controls {
            margin-bottom: 16px;
            padding: 12px;
            background-color: #F8F9FA;
            border-radius: 4px;
            border: 1px solid #E5E5E5;
        }
        
        .ignore-controls h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            font-weight: 600;
        }
        
        .ignore-controls .checkbox-item {
            margin-bottom: 4px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Check if XLSX library loaded successfully
        window.addEventListener('load', function() {
            if (typeof XLSX === 'undefined') {
                console.error('XLSX library failed to load');
                // Try alternative CDN
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
                script.onload = function() {
                    console.log('XLSX library loaded from alternative CDN');
                };
                script.onerror = function() {
                    console.error('Failed to load XLSX library from alternative CDN');
                };
                document.head.appendChild(script);
            } else {
                console.log('XLSX library loaded successfully');
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>MiracleData™</h1>
        
        <div class="tab-container">
            <div class="tab active" data-tab="import-sports">Import Sports Data</div>
            <div class="tab" data-tab="spreadsheet-import">Spreadsheet Import</div>
            <div class="tab" data-tab="duplicate">Duplicate Collections</div>
            <div class="tab" data-tab="import-export">Import/Export JSON</div>
        </div>
        
        <div id="import-sports" class="tab-content active">
            <div class="checkbox-group">
                <h3>Select Sports</h3>
                <div class="checkbox-item">
                    <input type="checkbox" id="nba" value="NBA">
                    <label for="nba">NBA (30 teams)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="nfl" value="NFL">
                    <label for="nfl">NFL (32 teams)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="mlb" value="MLB">
                    <label for="mlb">MLB (30 teams)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="nhl" value="NHL">
                    <label for="nhl">NHL (32 teams)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="wnba" value="WNBA">
                    <label for="wnba">WNBA (12 teams)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="ncaa" value="NCAA Football">
                    <label for="ncaa">NCAA Football (25 teams)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="mens-tennis" value="Men's Tennis">
                    <label for="mens-tennis">Men's Tennis (Top 40 players)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="womens-tennis" value="Women's Tennis">
                    <label for="womens-tennis">Women's Tennis (Top 40 players)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="mens-golf" value="Men's Golf">
                    <label for="mens-golf">Men's Golf (Top 40 players)</label>
                </div>
            </div>
            
            <div class="button-group">
                <button id="fetchData">Fetch Sports Data</button>
                <button id="selectAll" class="secondary">Select All</button>
                <button id="deselectAll" class="secondary">Deselect All</button>
            </div>
            
            <div id="successMessage" class="success-message" style="display: none;"></div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
        
        <div id="spreadsheet-import" class="tab-content">
            <div class="section">
                <h3>Import Spreadsheet Data</h3>
                <div class="form-group">
                    <label for="spreadsheetFile">Select File or Enter Google Sheets URL</label>
                    <input type="file" id="spreadsheetFile" accept=".csv,.xlsx,.xls,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                    <div style="margin: 8px 0; text-align: center; color: #666;">OR</div>
                    <input type="url" id="googleSheetsUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
                </div>
                
                <div class="form-group">
                    <label for="collectionName">Collection Name</label>
                    <input type="text" id="collectionName" placeholder="Enter collection name">
                </div>
                
                <button id="parseSpreadsheet" disabled>Parse Spreadsheet</button>
            </div>
            
            <div id="spreadsheetPreview" class="section" style="display: none;">
                <h3>Preview & Mapping</h3>
                <div id="previewGrid" style="max-height: 300px; overflow: auto; border: 1px solid #E5E5E5; border-radius: 4px;">
                    <!-- Preview grid will be populated here -->
                </div>
                
                <div class="form-group" style="margin-top: 16px;">
                    <label>Column Mapping</label>
                    <div id="columnMapping">
                        <!-- Column mapping will be populated here -->
                    </div>
                </div>
                
                <button id="importSpreadsheet" disabled>Import to Figma</button>
            </div>
            
            <div id="spreadsheetError" class="error-message" style="display: none;"></div>
            <div id="spreadsheetSuccess" class="success-message" style="display: none;"></div>
        </div>
        
        <div id="duplicate" class="tab-content">
            <div class="form-group">
                <label for="collectionSelect">Select Collection</label>
                <select id="collectionSelect">
                    <option value="">Loading collections...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="newCollectionName">New Collection Name (optional)</label>
                <input type="text" id="newCollectionName" placeholder="Enter name or leave blank for auto-name">
            </div>
            
            <button id="duplicateBtn">Duplicate Collection</button>
        </div>
        
        <div id="import-export" class="tab-content">
            <div class="section">
                <h3>Export Collection</h3>
                <div class="form-group">
                    <label for="exportCollectionSelect">Select Collection</label>
                    <select id="exportCollectionSelect">
                        <option value="">Loading collections...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Export Format</label>
                    <div class="checkbox-item">
                        <input type="radio" id="formatDefault" name="exportFormat" value="default" checked>
                        <label for="formatDefault">Default Format</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" id="formatToken" name="exportFormat" value="token">
                        <label for="formatToken">Design Token Format</label>
                    </div>
                </div>
                <button id="exportBtn">Export Collection</button>
            </div>
            
            <div class="section">
                <h3>Import Collection</h3>
                <div class="form-group">
                    <label for="importFile">Select JSON File</label>
                    <input type="file" id="importFile" accept=".json">
                </div>
                <div id="importValidation" class="validation-message" style="display: none;"></div>
                <button id="importBtn" disabled>Import Collection</button>
            </div>
        </div>
    </div>
    
    <script>
        // Tab switching logic
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Load collections when switching to duplicate or import/export tab
                if (tabId === 'duplicate' || tabId === 'import-export') {
                    parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');
                }
                
                // Reset spreadsheet import state when switching away
                if (tabId !== 'spreadsheet-import') {
                    document.getElementById('spreadsheetPreview').style.display = 'none';
                    document.getElementById('spreadsheetError').style.display = 'none';
                    document.getElementById('spreadsheetSuccess').style.display = 'none';
                    spreadsheetData = null;
                    ignoredColumns.clear();
                    ignoredRows.clear();
                }
            });
        });
        
        // Select/deselect all buttons
        document.getElementById('selectAll').addEventListener('click', () => {
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        });
        
        document.getElementById('deselectAll').addEventListener('click', () => {
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        });
        
        // Fetch data button
        document.getElementById('fetchData').addEventListener('click', () => {
            const selectedSports = [];
            document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked').forEach(cb => {
                selectedSports.push(cb.value);
            });
            
            if (selectedSports.length === 0) {
                alert('Please select at least one sport.');
                return;
            }
            
            // Disable buttons during fetch
            document.getElementById('fetchData').disabled = true;
            document.getElementById('selectAll').disabled = true;
            document.getElementById('deselectAll').disabled = true;
            
            // Hide any previous messages
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Send message to plugin
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'fetch-sports-data',
                    selectedSports: selectedSports
                } 
            }, '*');
        });
        
        // Duplicate button
        document.getElementById('duplicateBtn').addEventListener('click', () => {
            const collectionId = document.getElementById('collectionSelect').value;
            const newName = document.getElementById('newCollectionName').value;
            
            if (!collectionId) {
                alert('Please select a collection to duplicate.');
                return;
            }
            
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'duplicate-collection',
                    collectionId: collectionId,
                    newName: newName
                } 
            }, '*');
        });
        
        // Auto-populate new collection name when collection is selected
        document.getElementById('collectionSelect').addEventListener('change', (event) => {
            const selectedOption = event.target.options[event.target.selectedIndex];
            if (selectedOption && selectedOption.textContent) {
                const newNameInput = document.getElementById('newCollectionName');
                newNameInput.value = `${selectedOption.textContent} (Copy)`;
            }
        });
        
        // Export button
        document.getElementById('exportBtn').addEventListener('click', () => {
            const collectionId = document.getElementById('exportCollectionSelect').value;
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            
            if (!collectionId) {
                alert('Please select a collection to export.');
                return;
            }
            
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'export-collection',
                    collectionId: collectionId,
                    format: format
                } 
            }, '*');
        });
        
        // Import file handling
        document.getElementById('importFile').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('importBtn').disabled = true;
                document.getElementById('importValidation').style.display = 'none';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate the data
                    parent.postMessage({ 
                        pluginMessage: { 
                            type: 'validate-collection-import',
                            data: data
                        } 
                    }, '*');
                    
                } catch (error) {
                    document.getElementById('importValidation').style.display = 'block';
                    document.getElementById('importValidation').className = 'validation-message invalid';
                    document.getElementById('importValidation').innerHTML = `Invalid JSON file: ${error.message}`;
                    document.getElementById('importBtn').disabled = true;
                }
            };
            reader.readAsText(file);
        });
        
        // Import button
        document.getElementById('importBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    parent.postMessage({ 
                        pluginMessage: { 
                            type: 'import-collection',
                            data: data,
                            fileName: file.name
                        } 
                    }, '*');
                    
                } catch (error) {
                    alert(`Error parsing JSON file: ${error.message}`);
                }
            };
            reader.readAsText(file);
        });
        
        // Function to handle file download
        function downloadObjectAsJson(exportObj, exportName) {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", exportName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        // Function to handle fetch requests from the plugin
        async function handleFetchRequest(request) {
            try {
                console.log(`UI received fetch request for: ${request.url}`);
                
                // Make the actual fetch request from the UI (browser context)
                const response = await fetch(request.url, { credentials: 'omit' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                // Try JSON, fall back to text
                let data;
                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    data = { __rawText: text };
                }
                
                // Send the data back to the plugin
                parent.postMessage({
                    pluginMessage: {
                        type: 'fetch-response',
                        requestId: request.requestId,
                        data: data
                    }
                }, '*');
                
                console.log(`UI successfully fetched data from: ${request.url}`);
            } catch (error) {
                console.error(`UI fetch error for ${request.url}:`, error);
                
                // Send error back to the plugin
                parent.postMessage({
                    pluginMessage: {
                        type: 'fetch-response',
                        requestId: request.requestId,
                        error: error.message
                    }
                }, '*');
            }
        }
        
        // Listen for messages from the plugin
        window.onmessage = async (event) => {
            const msg = event.data.pluginMessage;
            
            // Handle fetch requests from the plugin
            if (msg && msg.type === 'fetch-request') {
                handleFetchRequest(msg);
                return;
            }
            
            if (msg && msg.type === 'error') {
                // Reset button states
                document.getElementById('fetchData').disabled = false;
                document.getElementById('selectAll').disabled = false;
                document.getElementById('deselectAll').disabled = false;
                
                // Show error message
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = msg.message;
                
            } else if (msg && msg.type === 'success') {
                alert('Success: ' + msg.message);
                
            } else if (msg && msg.type === 'collections-loaded') {
                // Populate collection dropdowns
                const collections = msg.collections;
                
                const duplicateSelect = document.getElementById('collectionSelect');
                const exportSelect = document.getElementById('exportCollectionSelect');
                
                duplicateSelect.innerHTML = '';
                exportSelect.innerHTML = '';
                
                if (collections.length === 0) {
                    duplicateSelect.innerHTML = '<option value="">No collections available</option>';
                    exportSelect.innerHTML = '<option value="">No collections available</option>';
                } else {
                    duplicateSelect.innerHTML = '<option value="">Select a collection...</option>';
                    exportSelect.innerHTML = '<option value="">Select a collection...</option>';
                    
                    collections.forEach(collection => {
                        const option1 = document.createElement('option');
                        option1.value = collection.id;
                        option1.textContent = collection.name;
                        duplicateSelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = collection.id;
                        option2.textContent = collection.name;
                        exportSelect.appendChild(option2);
                    });
                }
                
            } else if (msg && msg.type === 'sports-data-fetched') {
                // Show success message
                const results = msg.results || [];
                const successCount = results.filter(r => r.success).length;
                
                if (successCount > 0) {
                    const successMessage = document.getElementById('successMessage');
                    successMessage.style.display = 'block';
                    successMessage.textContent = `Successfully created variables for ${successCount} sport(s)!`;
                }
                
                // Reset button states immediately
                document.getElementById('fetchData').disabled = false;
                document.getElementById('selectAll').disabled = false;
                document.getElementById('deselectAll').disabled = false;
                
            } else if (msg && msg.type === 'sports-data-error') {
                // Show error message
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = msg.message;
                
                // Reset button states
                document.getElementById('fetchData').disabled = false;
                document.getElementById('selectAll').disabled = false;
                document.getElementById('deselectAll').disabled = false;
                
            } else if (msg && msg.type === 'export-data-ready') {
                // Download the data as JSON
                downloadObjectAsJson(msg.data, msg.fileName || 'miracle_data_export.json');
                
            } else if (msg && msg.type === 'collection-validation-result') {
                const result = msg.result;
                const validationDiv = document.getElementById('importValidation');
                validationDiv.style.display = 'block';
                
                if (result.valid) {
                    const formatLabel = result.format === 'token' ? 'Design Token Format' : 'Figma Variables Format';
                    validationDiv.className = 'validation-message valid';
                    validationDiv.innerHTML = `✓ Valid collection (${formatLabel}): ${result.message}`;
                    document.getElementById('importBtn').disabled = false;
                } else {
                    validationDiv.className = 'validation-message invalid';
                    validationDiv.innerHTML = `✗ Invalid collection: ${result.message}`;
                    document.getElementById('importBtn').disabled = true;
                }
                
            } else if (msg && msg.type === 'import-collection-success') {
                const formatLabel = msg.result.format === 'token' ? 'Design Token Format' : 'Figma Variables Format';
                alert(`Collection "${msg.result.collectionName}" imported successfully! (${formatLabel})\n\nCreated: ${msg.result.created}\nUpdated: ${msg.result.updated}\nSkipped: ${msg.result.skipped}`);
                
                // Refresh collections list
                parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');
                
            } else if (msg && msg.type === 'import-collection-error') {
                alert(`Error importing collection: ${msg.message}`);
            } else if (msg && msg.type === 'spreadsheet-import-success') {
                // Show success message
                document.getElementById('spreadsheetSuccess').style.display = 'block';
                document.getElementById('spreadsheetSuccess').textContent = `Successfully imported ${msg.created} variables!`;
                
                // Hide error message if shown
                document.getElementById('spreadsheetError').style.display = 'none';
                
                // Enable import button
                document.getElementById('importSpreadsheet').disabled = false;
                
            } else if (msg && msg.type === 'spreadsheet-import-error') {
                // Show error message
                document.getElementById('spreadsheetError').style.display = 'block';
                document.getElementById('spreadsheetError').textContent = msg.message;
                
                // Hide success message if shown
                document.getElementById('spreadsheetSuccess').style.display = 'none';
                
            } else if (msg && msg.type === 'variables-api-unavailable') {
                // Handle case when variables API is not available
                console.log('Received variables-api-unavailable message:', msg);
                
                // Create a custom modal instead of using confirm
                const modalContainer = document.createElement('div');
                modalContainer.style.position = 'fixed';
                modalContainer.style.top = '0';
                modalContainer.style.left = '0';
                modalContainer.style.width = '100%';
                modalContainer.style.height = '100%';
                modalContainer.style.backgroundColor = 'rgba(0,0,0,0.5)';
                modalContainer.style.display = 'flex';
                modalContainer.style.justifyContent = 'center';
                modalContainer.style.alignItems = 'center';
                modalContainer.style.zIndex = '9999';
                
                const modalContent = document.createElement('div');
                modalContent.style.backgroundColor = 'white';
                modalContent.style.padding = '24px';
                modalContent.style.borderRadius = '8px';
                modalContent.style.maxWidth = '400px';
                modalContent.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                
                const modalTitle = document.createElement('h3');
                modalTitle.textContent = 'Variables API Not Available';
                modalTitle.style.margin = '0 0 16px 0';
                modalTitle.style.fontSize = '16px';
                modalTitle.style.fontWeight = '600';
                
                const modalMessage = document.createElement('p');
                modalMessage.textContent = 'The variables API is not available in this document. Would you like to download the converted data as a JSON file instead?';
                modalMessage.style.margin = '0 0 24px 0';
                modalMessage.style.lineHeight = '1.5';
                
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.justifyContent = 'flex-end';
                buttonContainer.style.gap = '8px';
                
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.className = 'secondary';
                cancelButton.onclick = () => {
                    document.body.removeChild(modalContainer);
                };
                
                const downloadButton = document.createElement('button');
                downloadButton.textContent = 'Download JSON';
                downloadButton.onclick = () => {
                    // Download the converted data
                    downloadObjectAsJson(msg.data, msg.fileName || 'converted-tokens.json');
                    document.body.removeChild(modalContainer);
                };
                
                buttonContainer.appendChild(cancelButton);
                buttonContainer.appendChild(downloadButton);
                
                modalContent.appendChild(modalTitle);
                modalContent.appendChild(modalMessage);
                modalContent.appendChild(buttonContainer);
                modalContainer.appendChild(modalContent);
                
                document.body.appendChild(modalContainer);
            }
        };
        
        // Spreadsheet import functionality
        let spreadsheetData = null;
        let ignoredColumns = new Set();
        let ignoredRows = new Set();
        
        // Enable parse button when file is selected or URL is entered
        function updateParseButton() {
            const fileInput = document.getElementById('spreadsheetFile');
            const urlInput = document.getElementById('googleSheetsUrl');
            const parseBtn = document.getElementById('parseSpreadsheet');
            
            parseBtn.disabled = !(fileInput.files.length > 0 || urlInput.value.trim());
        }
        
        document.getElementById('spreadsheetFile').addEventListener('change', updateParseButton);
        document.getElementById('googleSheetsUrl').addEventListener('input', updateParseButton);
        
        // Parse spreadsheet button
        document.getElementById('parseSpreadsheet').addEventListener('click', async () => {
            const fileInput = document.getElementById('spreadsheetFile');
            const urlInput = document.getElementById('googleSheetsUrl');
            const collectionName = document.getElementById('collectionName').value;
            
            if (!collectionName.trim()) {
                alert('Please enter a collection name.');
                return;
            }
            
            try {
                let data;
                
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileType = file.name.split('.').pop().toLowerCase();
                    
                    if (fileType === 'csv') {
                        data = await parseCSV(file);
                    } else if (fileType === 'xlsx' || fileType === 'xls') {
                        try {
                            data = await parseXLSX(file);
                        } catch (xlsxError) {
                            console.error('XLSX parsing failed:', xlsxError);
                            // Try alternative parsing method
                            try {
                                data = await parseXLSXAlternative(file);
                            } catch (altError) {
                                throw new Error(`Failed to parse Excel file: ${xlsxError.message}. Please try converting to CSV format.`);
                            }
                        }
                    } else {
                        throw new Error('Unsupported file type. Please use CSV, XLS, or XLSX files.');
                    }
                } else if (urlInput.value.trim()) {
                    data = await parseGoogleSheets(urlInput.value.trim());
                } else {
                    throw new Error('Please select a file or enter a Google Sheets URL.');
                }
                
                spreadsheetData = data;
                displayPreview(data);
                document.getElementById('spreadsheetPreview').style.display = 'block';
                
            } catch (error) {
                console.error('Error parsing spreadsheet:', error);
                document.getElementById('spreadsheetError').style.display = 'block';
                document.getElementById('spreadsheetError').textContent = 'Error parsing spreadsheet: ' + error.message;
            }
        });
        
        // CSV parsing function
        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(line => line.trim());
                        
                        if (lines.length === 0) {
                            throw new Error('CSV file is empty');
                        }
                        
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        const rows = lines.slice(1).map(line => 
                            line.split(',').map(cell => cell.trim().replace(/"/g, ''))
                        );
                        
                        resolve({ headers, rows });
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }
        
        // XLSX parsing function using SheetJS
        async function parseXLSX(file) {
            return new Promise((resolve, reject) => {
                console.log('Starting XLSX parsing for file:', file.name, 'Size:', file.size);
                
                // Check if XLSX library is loaded
                if (typeof XLSX === 'undefined') {
                    reject(new Error('XLSX library not loaded. Please refresh the page and try again.'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        console.log('File read successfully, size:', e.target.result.byteLength);
                        
                        const data = new Uint8Array(e.target.result);
                        console.log('Creating workbook from data...');
                        
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('Workbook created, sheet names:', workbook.SheetNames);
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error('No worksheets found in the file');
                        }
                        
                        // Get the first worksheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        if (!worksheet) {
                            throw new Error('Could not access the first worksheet');
                        }
                        
                        console.log('Converting worksheet to JSON...');
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        console.log('JSON data length:', jsonData.length);
                        
                        if (jsonData.length === 0) {
                            throw new Error('XLSX file is empty or contains no data');
                        }
                        
                        // Extract headers and rows
                        const headers = jsonData[0].map(h => String(h || '').trim());
                        const rows = jsonData.slice(1).map(row => 
                            row.map(cell => String(cell || '').trim())
                        );
                        
                        console.log('Parsed headers:', headers);
                        console.log('Parsed rows count:', rows.length);
                        
                        resolve({ headers, rows });
                    } catch (error) {
                        console.error('Error parsing XLSX:', error);
                        reject(new Error('Failed to parse XLSX file: ' + error.message));
                    }
                };
                reader.onerror = () => {
                    console.error('FileReader error');
                    reject(new Error('Failed to read file'));
                };
                
                console.log('Reading file as ArrayBuffer...');
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Alternative XLSX parsing function
        async function parseXLSXAlternative(file) {
            return new Promise((resolve, reject) => {
                console.log('Trying alternative XLSX parsing...');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        console.log('Alternative parsing - data type:', typeof data);
                        
                        // Try different parsing options
                        const workbook = XLSX.read(data, { 
                            type: 'binary',
                            cellDates: true,
                            cellNF: false,
                            cellText: false
                        });
                        
                        console.log('Alternative workbook created, sheet names:', workbook.SheetNames);
                        
                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            throw new Error('No worksheets found in the file');
                        }
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        if (!worksheet) {
                            throw new Error('Could not access the first worksheet');
                        }
                        
                        // Try different conversion options
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            header: 1,
                            defval: '',
                            blankrows: false
                        });
                        
                        console.log('Alternative JSON data length:', jsonData.length);
                        
                        if (jsonData.length === 0) {
                            throw new Error('XLSX file is empty or contains no data');
                        }
                        
                        // Extract headers and rows
                        const headers = jsonData[0].map(h => String(h || '').trim());
                        const rows = jsonData.slice(1).map(row => 
                            row.map(cell => String(cell || '').trim())
                        );
                        
                        console.log('Alternative parsing successful');
                        resolve({ headers, rows });
                    } catch (error) {
                        console.error('Alternative XLSX parsing failed:', error);
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsBinaryString(file);
            });
        }
        
        // Google Sheets parsing function
        async function parseGoogleSheets(url) {
            try {
                // Extract sheet ID from URL
                const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                if (!match) {
                    throw new Error('Invalid Google Sheets URL');
                }
                
                const sheetId = match[1];
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch Google Sheets data');
                }
                
                const text = await response.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    throw new Error('Google Sheet is empty');
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const rows = lines.slice(1).map(line => 
                    line.split(',').map(cell => cell.trim().replace(/"/g, ''))
                );
                
                return { headers, rows };
            } catch (error) {
                throw new Error('Failed to parse Google Sheets: ' + error.message);
            }
        }
        
        // Display preview grid
        function displayPreview(data) {
            const previewGrid = document.getElementById('previewGrid');
            const { headers, rows } = data;
            
            // Create grid
            const grid = document.createElement('div');
            grid.className = 'preview-grid';
            grid.style.gridTemplateColumns = `repeat(${headers.length}, 1fr)`;
            
            // Add headers
            headers.forEach((header, index) => {
                const cell = document.createElement('div');
                cell.className = 'preview-cell preview-header';
                cell.textContent = header;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = true;
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        ignoredColumns.delete(index);
                    } else {
                        ignoredColumns.add(index);
                    }
                    updatePreview();
                });
                
                cell.appendChild(checkbox);
                grid.appendChild(cell);
            });
            
            // Add rows (limit to first 10 for preview)
            const previewRows = rows.slice(0, 10);
            previewRows.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'preview-cell';
                    cellDiv.textContent = cell || '';
                    grid.appendChild(cellDiv);
                });
            });
            
            previewGrid.innerHTML = '';
            previewGrid.appendChild(grid);
            
            // Create column mapping
            createColumnMapping(headers);
        }
        
        // Create column mapping interface
        function createColumnMapping(headers) {
            const mappingContainer = document.getElementById('columnMapping');
            mappingContainer.innerHTML = '';
            
            const figmaFields = [
                'Full Team Name',
                'Logo',
                'City', 
                'Short Name',
                'TriCode',
                'Primary Color',
                'Secondary Color',
                'Early Record',
                'Mid Record',
                'Late Record',
                'Rank'
            ];
            
            headers.forEach((header, index) => {
                if (ignoredColumns.has(index)) return;
                
                const item = document.createElement('div');
                item.className = 'column-mapping-item';
                
                const label = document.createElement('label');
                label.textContent = header;
                item.appendChild(label);
                
                const select = document.createElement('select');
                select.innerHTML = '<option value="">-- Select Figma Field --</option>';
                figmaFields.forEach(field => {
                    const option = document.createElement('option');
                    option.value = field;
                    option.textContent = field;
                    select.appendChild(option);
                });
                item.appendChild(select);
                
                mappingContainer.appendChild(item);
            });
        }
        
        // Update preview when ignore settings change
        function updatePreview() {
            if (!spreadsheetData) return;
            displayPreview(spreadsheetData);
        }
        
        // Import spreadsheet button
            document.getElementById('importSpreadsheet').addEventListener('click', () => {
            const collectionName = document.getElementById('collectionName').value;
            const mappingItems = document.querySelectorAll('.column-mapping-item');
            
            const columnMapping = {};
            const savedMapping = {};
            mappingItems.forEach(item => {
                const label = item.querySelector('label').textContent;
                const select = item.querySelector('select');
                if (select.value) {
                    columnMapping[label] = select.value;
                }
                savedMapping[label] = select.value || '';
            });
            
            if (Object.keys(columnMapping).length === 0) {
                alert('Please map at least one column to a Figma field.');
                return;
            }
            
            parent.postMessage({
            pluginMessage: {
                type: 'import-spreadsheet',
                collectionName: collectionName,
                data: spreadsheetData,
                columnMapping: columnMapping,
                ignoredColumns: Array.from(ignoredColumns),
                ignoredRows: Array.from(ignoredRows)
            }
        }, '*');
        });
        
        // Initial load of collections for duplicate tab
        parent.postMessage({ pluginMessage: { type: 'get-collections' } }, '*');

    </script>
</body>
</html>